#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ë–´–°–¢–†–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –°–ò–°–¢–ï–ú–´
=====================================

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
- –°–µ—Ä–≤–µ—Ä –∏ API endpoints
- Master Tools System –∞–¥–∞–ø—Ç–µ—Ä
- Coordinator agent
- Specialist agents –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- Role agents –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
"""

import os
import sys
import importlib.util
import requests
import json
from datetime import datetime

def check_server_api():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ API —Å–µ—Ä–≤–µ—Ä–∞"""
    print("üñ•Ô∏è Checking server and API...")
    
    results = {
        'server_running': False,
        'health_endpoint': False,
        'ai_chat_endpoint': False
    }
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
        response = requests.get("http://localhost:8000/health", timeout=5)
        results['health_endpoint'] = response.status_code == 200
        
        if results['health_endpoint']:
            results['server_running'] = True
            print("‚úÖ Server is running")
            print("‚úÖ Health endpoint OK")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º AI chat endpoint
        test_payload = {
            "message": "test",
            "context_search": False,
            "max_context": 1
        }
        response = requests.post(
            "http://localhost:8000/api/ai/chat",
            json=test_payload,
            timeout=10
        )
        results['ai_chat_endpoint'] = response.status_code == 200
        
        if results['ai_chat_endpoint']:
            print("‚úÖ AI chat endpoint responding")
        else:
            print(f"‚ùå AI chat endpoint error: {response.status_code}")
        
    except requests.exceptions.ConnectionError:
        print("‚ùå Server not running on localhost:8000")
    except Exception as e:
        print(f"‚ùå Server check error: {e}")
    
    return results

def check_tools_adapter():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ Master Tools System –∞–¥–∞–ø—Ç–µ—Ä–∞"""
    print("\nüîß Checking Master Tools System adapter...")
    
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å
        sys.path.append('C:/Bldr/core')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –∞–¥–∞–ø—Ç–µ—Ä–∞
        from tools_adapter import get_tools_adapter
        
        # –°–æ–∑–¥–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä
        tools_adapter = get_tools_adapter()
        
        if tools_adapter:
            print("‚úÖ Tools adapter created successfully")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            if hasattr(tools_adapter, 'get_available_tools'):
                tools = tools_adapter.get_available_tools()
                print(f"‚úÖ Available tools: {len(tools)} tools")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                tool_names = list(tools.keys())[:5] if isinstance(tools, dict) else []
                if tool_names:
                    print(f"üìã Sample tools: {', '.join(tool_names)}")
                
                return True
            else:
                print("‚ö†Ô∏è Tools adapter missing get_available_tools method")
                return False
        else:
            print("‚ùå Failed to create tools adapter")
            return False
            
    except ImportError as e:
        print(f"‚ùå Import error: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Tools adapter error: {e}")
        return False

def check_coordinator_agent():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ coordinator agent"""
    print("\nüß† Checking coordinator agent...")
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç
        from agents.coordinator_agent import CoordinatorAgent
        from tools_adapter import get_tools_adapter
        
        # –°–æ–∑–¥–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
        tools_adapter = get_tools_adapter()
        coordinator = CoordinatorAgent(tools_system=tools_adapter)
        
        if coordinator:
            print("‚úÖ Coordinator agent created")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            if hasattr(coordinator, 'get_available_tools'):
                try:
                    tools = coordinator.get_available_tools()
                    print(f"‚úÖ Coordinator can access {len(tools)} tools")
                    return True
                except Exception as e:
                    print(f"‚ùå Coordinator tools access error: {e}")
                    return False
            else:
                print("‚ö†Ô∏è Coordinator missing get_available_tools method")
                return False
        else:
            print("‚ùå Failed to create coordinator")
            return False
            
    except ImportError as e:
        print(f"‚ùå Coordinator import error: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Coordinator error: {e}")
        return False

def check_specialist_agents():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ specialist agents"""
    print("\nü§ñ Checking specialist agents...")
    
    try:
        from agents.specialist_agents import SpecialistAgentsManager
        from tools_adapter import get_tools_adapter
        
        # –°–æ–∑–¥–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä –∏ –º–µ–Ω–µ–¥–∂–µ—Ä
        tools_adapter = get_tools_adapter()
        specialist_manager = SpecialistAgentsManager(tools_system=tools_adapter)
        
        if specialist_manager:
            print("‚úÖ Specialist agents manager created")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ tools_system
            if hasattr(specialist_manager, 'tools_system') and specialist_manager.tools_system:
                print("‚úÖ Specialist manager has tools_system access")
                return True
            else:
                print("‚ùå Specialist manager missing tools_system")
                return False
        else:
            print("‚ùå Failed to create specialist manager")
            return False
            
    except ImportError as e:
        print(f"‚ùå Specialist agents import error: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Specialist agents error: {e}")
        return False

def check_role_agents():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ role agents"""
    print("\nüé≠ Checking role agents...")
    
    try:
        from agents.roles_agents import RoleAgent
        from tools_adapter import get_tools_adapter
        
        # –°–æ–∑–¥–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä –∏ role agent
        tools_adapter = get_tools_adapter()
        role_agent = RoleAgent("analyst", tools_system=tools_adapter)
        
        if role_agent:
            print("‚úÖ Role agent created")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ _execute_master_tool
            if hasattr(role_agent, '_execute_master_tool'):
                print("‚úÖ Role agent has _execute_master_tool method")
                return True
            else:
                print("‚ùå Role agent missing _execute_master_tool method")
                return False
        else:
            print("‚ùå Failed to create role agent")
            return False
            
    except ImportError as e:
        print(f"‚ùå Role agents import error: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Role agents error: {e}")
        return False

def check_file_exists(filepath, description):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞"""
    if os.path.exists(filepath):
        size = os.path.getsize(filepath)
        print(f"‚úÖ {description}: {filepath} ({size} bytes)")
        return True
    else:
        print(f"‚ùå {description}: {filepath} - NOT FOUND")
        return False

def system_health_check():
    """–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã"""
    print("üè• SYSTEM HEALTH CHECK")
    print("="*50)
    print(f"üìÖ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
    print(f"\nüìÅ Checking key files...")
    files_check = [
        ("C:/Bldr/core/bldr_api.py", "Main API file"),
        ("C:/Bldr/core/tools_adapter.py", "Tools adapter"),
        ("C:/Bldr/agents/coordinator_agent.py", "Coordinator agent"),
        ("C:/Bldr/agents/specialist_agents.py", "Specialist agents"),
        ("C:/Bldr/agents/roles_agents.py", "Role agents"),
        ("C:/Bldr/test_fixed_architecture.py", "Architecture test"),
        ("C:/Bldr/run_final_test.py", "Final test runner")
    ]
    
    files_passed = 0
    for filepath, description in files_check:
        if check_file_exists(filepath, description):
            files_passed += 1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    print(f"\nüîç Checking system components...")
    
    components = [
        ("Server & API", check_server_api),
        ("Tools Adapter", check_tools_adapter), 
        ("Coordinator Agent", check_coordinator_agent),
        ("Specialist Agents", check_specialist_agents),
        ("Role Agents", check_role_agents)
    ]
    
    components_passed = 0
    component_results = {}
    
    for name, check_func in components:
        print(f"\n{'='*20} {name} {'='*20}")
        try:
            result = check_func()
            component_results[name] = result
            if result:
                components_passed += 1
        except Exception as e:
            print(f"‚ùå {name} check failed: {e}")
            component_results[name] = False
    
    # –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    print(f"\n{'='*50}")
    print("üìä HEALTH CHECK SUMMARY")
    print("="*50)
    
    print(f"üìÅ Files: {files_passed}/{len(files_check)} present")
    print(f"üîß Components: {components_passed}/{len(components)} working")
    
    total_score = (files_passed + components_passed) / (len(files_check) + len(components)) * 100
    print(f"üìà Overall Health: {total_score:.1f}%")
    
    if total_score >= 90:
        print("üéâ EXCELLENT! System is healthy and ready")
    elif total_score >= 70:
        print("‚úÖ GOOD! System mostly working, minor issues possible")
    elif total_score >= 50:
        print("‚ö†Ô∏è FAIR! Some components need attention")
    else:
        print("‚ùå POOR! Major issues need to be resolved")
    
    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    print(f"\nüìã RECOMMENDATIONS:")
    
    if not component_results.get("Server & API", False):
        print("   üîå Start the server: python app.py")
    
    if not component_results.get("Tools Adapter", False):
        print("   üîß Check tools_adapter.py import and initialization")
        
    if not component_results.get("Coordinator Agent", False):
        print("   üß† Check coordinator_agent.py integration with Master Tools System")
        
    if not component_results.get("Specialist Agents", False):
        print("   ü§ñ Check specialist_agents.py tools_system parameter")
        
    if not component_results.get("Role Agents", False):
        print("   üé≠ Check roles_agents.py _execute_master_tool method")
    
    if total_score >= 90:
        print("   ‚úÖ Ready for final testing: python run_final_test.py")
    
    return total_score >= 70

if __name__ == "__main__":
    print("üè• Starting System Health Check...")
    healthy = system_health_check()
    exit(0 if healthy else 1)