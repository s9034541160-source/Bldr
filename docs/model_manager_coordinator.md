# Bldr Empire v2 - ModelManager и Coordinator

## Структура компонентов

### ModelManager (core/model_manager.py)

Менеджер моделей для управления ролями и моделями в SuperBuilder.

#### Основные функции:
1. **Управление ролями** - загрузка и кэширование моделей для каждой роли
2. **LRU кэширование** - автоматическое удаление наименее используемых моделей
3. **TTL (Time To Live)** - автоматическое удаление моделей по истечении времени
4. **Приоритеты загрузки** - предзагрузка высокоприоритетных моделей
5. **Статистика использования** - отслеживание использования моделей

#### Роли из roles.txt:
- **coordinator** (приоритет 10) - DeepSeek-R1-0528-Qwen3-8B
- **chief_engineer** (приоритет 8) - qwen2.5-vl-7b
- **structural_engineer** (приоритет 7) - qwen3-8b
- **geotechnical_engineer** (приоритет 7) - qwen3-8b
- **analyst** (приоритет 6) - qwen3-8b
- **project_manager** (приоритет 6) - qwen3-8b
- **construction_worker** (приоритет 5) - qwen3-8b
- **quality_control_officer** (приоритет 5) - qwen3-8b

#### Конфигурация:
- Максимальный размер кэша: 12 моделей
- TTL: 30 минут
- Приоритеты загрузки согласно roles.txt

### Coordinator (core/coordinator.py)

Центральный интеллект системы SuperBuilder.

#### Основные функции:
1. **Анализ запросов** - определение типа запроса и необходимых инструментов
2. **Формирование плана** - создание JSON-плана действий
3. **Выполнение инструментов** - запуск инструментов через ToolsSystem
4. **Синтез ответа** - объединение результатов в финальный ответ

#### Типы запросов:
- **Финансовые** - стоимость, смета, расчет, финанс, бюджет
- **Нормативные** - норма, СП, ГОСТ, СНиП, ФЗ, пункт
- **Проектные** - проект, ППР, технологическая карта, работы
- **Общие** - все остальные запросы

### Интеграция в BldrRAGTrainer

#### Новые компоненты:
1. **ModelManager** - инициализация в `__init__`
2. **ToolsSystem** - система инструментов для выполнения задач
3. **Coordinator** - координатор запросов

#### Новые методы:
1. **query_with_roles** - выполнение запросов с использованием ролевой системы
2. **ToolsSystem.execute_tool** - выполнение инструментов
3. **ToolsSystem._search_rag_database** - поиск в RAG базе данных
4. **ToolsSystem._calculate_estimate** - расчет сметы

## Использование

### ModelManager:
```python
# Инициализация
model_manager = ModelManager(max_cache_size=12, ttl_minutes=30)

# Получение клиента модели
model_client = model_manager.get_model_client("analyst")

# Получение статистики
stats = model_manager.get_model_stats()

# Предзагрузка приоритетных моделей
model_manager.preload_priority_models()
```

### Coordinator:
```python
# Инициализация
coordinator = Coordinator(model_manager, tools_system, rag_system)

# Обработка запроса
response = coordinator.process_request("Рассчитайте стоимость устройства фундамента")

# Анализ запроса
plan = coordinator.analyze_request("Какие нормы СП относятся к бетонным работам?")

# Синтез ответа
final_response = coordinator.synthesize_response(
    user_query="Вопрос", 
    tool_results=[...], 
    specialist_responses=[...]
)
```

### BldrRAGTrainer:
```python
# Инициализация с новыми компонентами
trainer = BldrRAGTrainer()

# Запрос с использованием ролей
result = trainer.query_with_roles(
    question="Рассчитайте стоимость", 
    roles=["analyst", "chief_engineer"]
)

# Стандартный запрос
result = trainer.query("cl.5.2 СП31")
```

## Совместимость

Новые компоненты полностью совместимы с:
- Существующей архитектурой SuperBuilder
- 14-этапным симбиотическим пайплайном
- Ролевой системой из roles.txt
- API эндпоинтами

## Преимущества

1. **Специализация** - каждая роль решает свою узкую задачу
2. **Эффективность** - модели загружаются по требованию с LRU-выгрузкой
3. **Масштабируемость** - легко добавлять новые роли
4. **Управляемость** - приоритеты загрузки, статистика использования, TTL
5. **Отказоустойчивость** - сбой одной модели не влияет на работу других