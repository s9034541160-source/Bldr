# Bldr Empire v2 - Backend API Integration

## Обновленные эндпоинты API

### WebSocket Endpoint
**`/ws`** - WebSocket endpoint для real-time обновлений во время обучения

**События:**
- `stage_update` - обновления этапов обучения
  ```json
  {
    "stage": "7/14",
    "log": "Rubern markup 0.99",
    "progress": 50
  }
  ```

### POST /train
Запуск процесса обучения RAG системы в фоновом режиме с real-time обновлениями.

**Response:**
```json
{
  "status": "Train started background",
  "message": "14 stages symbiotism processing... logs via WebSocket"
}
```

### POST /query
Выполнение семантического запроса к RAG системе с полными результатами.

**Request:**
```json
{
  "query": "cl.5.2 СП31",
  "k": 5
}
```

**Response:**
```json
{
  "results": [
    {
      "chunk": "tezis profit300млн ROI18% СП31 cl.5.2 BIM OVOS FЗ-44 viol99%",
      "meta": {
        "conf": 0.99,
        "entities": {
          "ORG": ["СП31", "BIM", "CL", "FЗ", "OVOS", "LSR"],
          "MONEY": ["300млн"],
          "PERCENT": ["99%"]
        },
        "work_sequences": ["seq1 deps seq2"]
      },
      "score": 0.99,
      "tezis": "profit300млн ROI18% rec LSR BIM+OVOS FЗ-44 conf0.99",
      "viol": 99
    }
  ],
  "ndcg": 0.95
}
```

## Интеграция с 14-этапным пайплайном

Во время обучения через `/train` отправляются реальные обновления по каждому из 14 этапов:

1. `1/14` - Начальная валидация документа завершена успешно
2. `2/14` - Проверка на дубликаты завершена успешно - документ уникален
3. `3/14` - Извлечение текстового содержимого завершено успешно
4. `4/14` - Определение типа документа завершено
5. `5/14` - Структурный анализ документа завершен успешно
6. `6/14` - Извлечено кандидатов-работ для передачи в Rubern
7. `7/14` - Генерация автоматической разметки Rubern завершена успешно
8. `8/14` - Извлечение метаданных завершено успешно
9. `9/14` - Контекстная обработка и контроль качества данных завершены успешно
10. `10/14` - Обработка с учетом типа документа завершена успешно
11. `11/14` - Извлечение и усиление рабочих последовательностей завершено успешно
12. `12/14` - Сохранение рабочих последовательностей завершено успешно
13. `13/14` - Разбиение документа и генерация векторных представлений завершены успешно
14. `14/14` - Сохранение фрагментов в Qdrant завершено успешно

## Тестирование API

### Curl команды для тестирования

1. **Health check:**
   ```bash
   curl -X POST http://localhost:8000/health
   ```

2. **Query test:**
   ```bash
   curl -X POST http://localhost:8000/query \
        -H "Content-Type: application/json" \
        -d '{"query": "cl.5.2 СП31", "k": 5}'
   ```

3. **Metrics:**
   ```bash
   curl -X GET http://localhost:8000/metrics
   ```

4. **Train (запуск в фоновом режиме):**
   ```bash
   curl -X POST http://localhost:8000/train
   ```

## Запуск системы

1. **Установка зависимостей:**
   ```bash
   pip install -r requirements.txt
   ```
   или запустите `setup_backend.bat`

2. **Запуск backend сервера:**
   ```bash
   python core/bldr_api.py
   ```
   или запустите `start_backend.bat`

3. **Тестирование API:**
   ```bash
   python test_api.py
   ```

## Интеграция с React Dashboard

React компонент использует следующие функции:

1. **WebSocket соединение** для получения real-time обновлений этапов обучения
2. **POST /train** для запуска процесса обучения
3. **POST /query** для выполнения семантических запросов
4. **GET /metrics** для получения метрик системы

## Совместимость

API полностью совместим с существующей архитектурой SuperBuilder:
- Использует те же модели и базы данных (Neo4j, Qdrant)
- Сохраняет формат данных для совместимости с существующими компонентами
- Поддерживает все существующие эндпоинты с расширенной функциональностью