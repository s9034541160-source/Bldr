#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –¥–ª—è recursive –ì–û–°–¢-—á–∞–Ω–∫–∏–Ω–≥–∞
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç 3-—É—Ä–æ–≤–Ω–µ–≤—É—é –∏–µ—Ä–∞—Ä—Ö–∏—é (6‚Üí6.2‚Üí6.2.3)
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from enterprise_rag_trainer_full import EnterpriseRAGTrainer

def test_recursive_gost_chunking():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç recursive –ì–û–°–¢-—á–∞–Ω–∫–∏–Ω–≥ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–∏–º–µ—Ä–æ–º"""
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç—Ä–µ–Ω–µ—Ä–∞
    trainer = EnterpriseRAGTrainer()
    
    # –ü—Ä–∏–º–µ—Ä –ì–û–°–¢-–¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å 3-—É—Ä–æ–≤–Ω–µ–≤–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–µ–π
    gost_content = """
6. –û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

6.1 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ì–û–°–¢ 12345-2020.

6.1.1 –°—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∏–∑ —Å—Ç–∞–ª–∏ –º–∞—Ä–∫–∏ –°255.

6.1.2 –ë–µ—Ç–æ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å—É –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ –í25.

6.2 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –º–æ–Ω—Ç–∞–∂—É

6.2.1 –ú–æ–Ω—Ç–∞–∂ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º.

6.2.2 –°–≤–∞—Ä–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ì–û–°–¢ 5264-80.

6.2.3 –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ —Å–≤–∞—Ä–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ì–û–°–¢ 3242-79.

6.2.3.1 –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –Ω–∞ 100% —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

6.2.3.2 –£–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –Ω–∞ 20% —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

6.3 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏—Å–ø—ã—Ç–∞–Ω–∏—è–º

6.3.1 –ò—Å–ø—ã—Ç–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –∏—Å–ø—ã—Ç–∞–Ω–∏–π.

6.3.2 –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—ã—Ç–∞–Ω–∏–π –¥–æ–ª–∂–Ω—ã –æ—Ñ–æ—Ä–º–ª—è—Ç—å—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º.
"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º recursive –ì–û–°–¢-—á–∞–Ω–∫–∏–Ω–≥...")
    print("=" * 50)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π —á–∞–Ω–∫–∏–Ω–≥
    chunks = trainer._custom_ntd_chunking(gost_content, "gost")
    
    print(f"üìä –°–æ–∑–¥–∞–Ω–æ {len(chunks)} —á–∞–Ω–∫–æ–≤:")
    print()
    
    for i, chunk in enumerate(chunks, 1):
        print(f"–ß–∞–Ω–∫ {i}:")
        print(f"  {chunk[:100]}...")
        print()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–∞–Ω–∫–∏–Ω–≥ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    base_metadata = {
        'doc_type': 'gost',
        'title': '–¢–µ—Å—Ç–æ–≤—ã–π –ì–û–°–¢',
        'canonical_id': 'test_gost_001'
    }
    
    chunk_data = trainer._custom_ntd_chunking_with_metadata(gost_content, "gost", base_metadata)
    
    print("üìã –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–æ–≤:")
    print("=" * 50)
    
    for i, data in enumerate(chunk_data, 1):
        metadata = data['metadata']
        print(f"–ß–∞–Ω–∫ {i}:")
        print(f"  –ù–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞: {metadata.get('punkt_num', 'N/A')}")
        print(f"  –£—Ä–æ–≤–µ–Ω—å –∏–µ—Ä–∞—Ä—Ö–∏–∏: {metadata.get('hierarchy_level', 'N/A')}")
        print(f"  –ü—É—Ç—å: {' ‚Üí '.join(metadata.get('parent_path', []))}")
        print(f"  –¢–∏–ø —á–∞–Ω–∫–∞: {metadata.get('chunk_type', 'N/A')}")
        print(f"  –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π: {metadata.get('is_structural', False)}")
        if 'gost_structure' in metadata:
            structure = metadata['gost_structure']
            print(f"  –†–∞–∑–¥–µ–ª: {structure.get('section', 'N/A')}")
            print(f"  –ü–æ–¥—Ä–∞–∑–¥–µ–ª: {structure.get('subsection', 'N/A')}")
            print(f"  –ü–æ–¥–ø–æ–¥—Ä–∞–∑–¥–µ–ª: {structure.get('subsubsection', 'N/A')}")
        print()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–µ—Ä–∞—Ä—Ö–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏:")
    print("=" * 50)
    
    for data in chunk_data:
        metadata = data['metadata']
        punkt_num = metadata.get('punkt_num', '')
        level = metadata.get('hierarchy_level', 0)
        parent_path = metadata.get('parent_path', [])
        
        print(f"–ü—É–Ω–∫—Ç {punkt_num}: —É—Ä–æ–≤–µ–Ω—å {level}, —Ä–æ–¥–∏—Ç–µ–ª–∏: {parent_path}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É –∏–µ—Ä–∞—Ä—Ö–∏–∏
        if punkt_num == "6.2.3.1":
            assert level == 4, f"–û–∂–∏–¥–∞–ª—Å—è —É—Ä–æ–≤–µ–Ω—å 4, –ø–æ–ª—É—á–µ–Ω {level}"
            assert "6.2.3" in parent_path, "6.2.3 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –ø—É—Ç–∏"
            print("  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –¥–ª—è 6.2.3.1")
        
        if punkt_num == "6.2.3":
            assert level == 3, f"–û–∂–∏–¥–∞–ª—Å—è —É—Ä–æ–≤–µ–Ω—å 3, –ø–æ–ª—É—á–µ–Ω {level}"
            assert "6.2" in parent_path, "6.2 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º –ø—É—Ç–∏"
            print("  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –¥–ª—è 6.2.3")
    
    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    print("‚úÖ Recursive –ì–û–°–¢-—á–∞–Ω–∫–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    print("‚úÖ 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
    print("‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ")

if __name__ == "__main__":
    test_recursive_gost_chunking()
